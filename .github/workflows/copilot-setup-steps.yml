name: Validate Copilot Configuration
on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - '.github/copilot-instructions.md'
      - '.github/README.md'

jobs:
  validate-copilot-config:
    runs-on: ubuntu-latest
    name: Validate GitHub Copilot Configuration
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Validate Copilot instructions content
        run: |
          echo "üîç Validating Copilot instructions for multi-repository workspace..."
          
          if [ ! -f ".github/copilot-instructions.md" ]; then
            echo "‚ùå Missing .github/copilot-instructions.md"
            exit 1
          fi
          
          # Check for essential multi-repository sections
          essential_sections=(
            "Multi-Repository Workspace"
            "Repository-Specific Responsibilities"
            "Issue Triage and Repository Assignment"
            "Block Annotation Best Practices"
            "Common Issues and Troubleshooting"
          )
          
          missing_sections=()
          for section in "${essential_sections[@]}"; do
            if ! grep -q "$section" .github/copilot-instructions.md; then
              missing_sections+=("$section")
            else
              echo "‚úÖ Found: $section"
            fi
          done
          
          if [ ${#missing_sections[@]} -gt 0 ]; then
            echo "‚ùå Missing essential sections:"
            printf "   - %s\n" "${missing_sections[@]}"
            exit 1
          fi
          
          # Check for modern block annotation patterns
          if grep -q '\$.*format.*deprecated.*%' .github/copilot-instructions.md; then
            echo "‚úÖ Found modern block annotation guidance"
          else
            echo "‚ö†Ô∏è  Missing guidance on modern block annotation patterns (\$ vs %)"
          fi
          
          # Check for workspace-specific content
          workspace_terms=(
            "setup.cmd"
            "npm link"
            "multi-repository"
            "workspace-root"
          )
          
          for term in "${workspace_terms[@]}"; do
            if grep -q "$term" .github/copilot-instructions.md; then
              echo "‚úÖ Found workspace reference: $term"
            else
              echo "‚ö†Ô∏è  Missing workspace reference: $term"
            fi
          done
          
      - name: Validate README consistency
        run: |
          echo "üîç Checking README consistency with instructions..."
          
          if [ ! -f ".github/README.md" ]; then
            echo "‚ö†Ô∏è  Missing .github/README.md"
          else
            # Check that README reflects multi-repository context
            if grep -q "multi-repository" .github/README.md; then
              echo "‚úÖ README mentions multi-repository context"
            else
              echo "‚ö†Ô∏è  README should mention multi-repository workspace"
            fi
          fi
          
      - name: Summary
        run: |
          echo "‚úÖ Copilot configuration validation completed!"
          echo ""
          echo "üìã Validation covered:"
          echo "  - Essential instruction sections"
          echo "  - Modern development practices"
          echo "  - Multi-repository workspace context"
          echo "  - Documentation consistency"
